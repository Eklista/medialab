---
title: Tablas - Comments & Feedback
description: Tablas del sistema de comentarios y feedback
---

# Comments & Feedback

## comments

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | UUID | Identificador √∫nico |
| commentable_type | ENUM | Tipo de entidad ('TASK', 'PROJECT', 'REQUEST', 'DELIVERABLE') |
| commentable_id | UUID | ID de la entidad comentada |
| parent_comment_id | UUID | ID del comentario padre (para threading) |
| user_id | UUID | ID del usuario que comenta |
| content | TEXT | Contenido del comentario |
| comment_type | ENUM | Tipo de comentario |
| is_internal | BOOLEAN | Solo visible para equipo interno |
| is_resolved | BOOLEAN | Comentario marcado como resuelto |
| mentions | JSONB | IDs de usuarios mencionados [@usuario] |
| attachments | JSONB | URLs de archivos adjuntos |
| edited_at | TIMESTAMP | Fecha de √∫ltima edici√≥n |
| deleted_at | TIMESTAMP | Fecha de soft delete |
| created_at | TIMESTAMP | Fecha de creaci√≥n |
| updated_at | TIMESTAMP | Fecha de modificaci√≥n |

### Relaciones
- **parent_comment_id** ‚Üí comments.id
- **user_id** ‚Üí users.id

### Tipos de comentario (comment_type):
- **GENERAL** ‚Üí Comentario general
- **FEEDBACK** ‚Üí Feedback espec√≠fico en revisiones
- **APPROVAL** ‚Üí Comentario de aprobaci√≥n
- **REJECTION** ‚Üí Comentario de rechazo (obligatorio)
- **SYSTEM** ‚Üí Comentario autom√°tico del sistema

### Tipos de entidad comentable (commentable_type):
- **TASK** ‚Üí Comentarios en tareas
- **PROJECT** ‚Üí Comentarios en proyectos
- **REQUEST** ‚Üí Comentarios en solicitudes
- **DELIVERABLE** ‚Üí Comentarios en entregables

### Estructura de mentions (JSONB):
```json
{
  "user_ids": ["uuid1", "uuid2"],
  "notified_at": "2024-01-15T10:30:00Z"
}
```

### Estructura de attachments (JSONB):
```json
{
  "files": [
    {
      "type": "image",
      "filename": "screenshot.png",
      "url": "https://storage.medialab/comments/abc123.png",
      "size": 1024000,
      "uploaded_at": "2024-01-15T10:30:00Z"
    },
    {
      "type": "link",
      "title": "Referencia de dise√±o",
      "url": "https://dribbble.com/shots/example",
      "preview_image": "https://cdn.dribbble.com/thumb.jpg"
    }
  ]
}
```

### √çndices recomendados:
```sql
CREATE INDEX idx_comments_commentable ON comments(commentable_type, commentable_id);
CREATE INDEX idx_comments_parent ON comments(parent_comment_id);
CREATE INDEX idx_comments_user ON comments(user_id);
CREATE INDEX idx_comments_mentions ON comments USING GIN(mentions);
CREATE INDEX idx_comments_active ON comments(commentable_type, commentable_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_comments_type ON comments(comment_type);
```

## comment_templates

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | UUID | Identificador √∫nico |
| name | VARCHAR | Nombre de la plantilla |
| category | ENUM | Categor√≠a del template |
| comment_type | ENUM | Tipo de comentario al que aplica |
| template_content | TEXT | Contenido de la plantilla |
| variables | JSONB | Variables disponibles en la plantilla |
| user_type_access | JSONB | Tipos de usuario que pueden usar la plantilla |
| is_active | BOOLEAN | Plantilla activa |
| created_by_user_id | UUID | ID del usuario creador |
| created_at | TIMESTAMP | Fecha de creaci√≥n |
| updated_at | TIMESTAMP | Fecha de modificaci√≥n |

### Relaciones
- **created_by_user_id** ‚Üí users.id

### Categor√≠as de template:
- **TECNICO** ‚Üí Feedback t√©cnico (calidad, formato, etc.)
- **CONTENIDO** ‚Üí Feedback de contenido
- **APROBACION** ‚Üí Templates de aprobaci√≥n
- **RECHAZO** ‚Üí Templates de rechazo
- **GENERAL** ‚Üí Templates generales

### Ejemplo de template_content:
```text
La calidad del video necesita mejoras en:
- [ ] Resoluci√≥n
- [ ] Estabilizaci√≥n  
- [ ] Iluminaci√≥n
- [ ] Audio

Comentarios espec√≠ficos:
{comentario_personalizado}
```

### Estructura de variables (JSONB):
```json
{
  "required_variables": ["comentario_personalizado"],
  "optional_variables": ["fecha_limite", "recursos_adicionales"],
  "placeholders": {
    "comentario_personalizado": "Escribe comentarios espec√≠ficos aqu√≠",
    "fecha_limite": "DD/MM/YYYY"
  }
}
```

## comment_reactions

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | UUID | Identificador √∫nico |
| comment_id | UUID | ID del comentario |
| user_id | UUID | ID del usuario que reacciona |
| reaction_type | ENUM | Tipo de reacci√≥n |
| created_at | TIMESTAMP | Fecha de creaci√≥n |

### Relaciones
- **comment_id** ‚Üí comments.id
- **user_id** ‚Üí users.id

### Tipos de reacci√≥n:
- **LIKE** ‚Üí üëç Like
- **HELPFUL** ‚Üí ‚úÖ √ötil
- **RESOLVED** ‚Üí ‚úîÔ∏è Resuelto
- **QUESTION** ‚Üí ‚ùì Pregunta
- **IMPORTANT** ‚Üí ‚ùó Importante

### Constraint √∫nico:
```sql
UNIQUE(comment_id, user_id) -- Un usuario solo puede reaccionar una vez por comentario
```

## comment_read_status

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | UUID | Identificador √∫nico |
| comment_id | UUID | ID del comentario |
| user_id | UUID | ID del usuario |
| read_at | TIMESTAMP | Fecha de lectura |
| created_at | TIMESTAMP | Fecha de creaci√≥n |

### Relaciones
- **comment_id** ‚Üí comments.id
- **user_id** ‚Üí users.id

### Constraint √∫nico:
```sql
UNIQUE(comment_id, user_id) -- Tracking de lectura √∫nico por usuario/comentario
```

## Flujo de Threading

### **Estructura jer√°rquica m√°xima**:
```
üìù Comentario principal (parent_comment_id = NULL)
  ‚Ü≥ üí¨ Respuesta nivel 1 (parent_comment_id = principal.id)
    ‚Ü≥ üí¨ Respuesta nivel 2 (parent_comment_id = respuesta1.id)
      ‚Ü≥ üí¨ Respuesta nivel 3 (parent_comment_id = respuesta2.id) [M√ÅXIMO]
```

### **Query para obtener thread completo**:
```sql
WITH RECURSIVE comment_thread AS (
    -- Comentario ra√≠z
    SELECT id, parent_comment_id, content, user_id, created_at, 0 as level
    FROM comments 
    WHERE id = ? AND deleted_at IS NULL
    
    UNION ALL
    
    -- Respuestas recursivas
    SELECT c.id, c.parent_comment_id, c.content, c.user_id, c.created_at, ct.level + 1
    FROM comments c
    INNER JOIN comment_thread ct ON c.parent_comment_id = ct.id
    WHERE c.deleted_at IS NULL AND ct.level < 3
)
SELECT * FROM comment_thread ORDER BY created_at ASC;
```

## Permisos por Entidad

### **Matriz de permisos de comentarios**:

| Entidad | Cliente | Colaborador | Admin | SuperAdmin |
|---------|---------|-------------|-------|------------|
| **TASK (propia)** | ‚úÖ Ver/Comentar | ‚úÖ Ver/Comentar | ‚úÖ Ver/Comentar | ‚úÖ Ver/Comentar |
| **TASK (ajena)** | ‚ùå | ‚úÖ Solo asignadas | ‚úÖ Todas | ‚úÖ Todas |
| **PROJECT (propio)** | ‚úÖ Ver/Comentar | ‚ùå | ‚úÖ Ver/Comentar | ‚úÖ Ver/Comentar |
| **PROJECT (ajeno)** | ‚ùå | ‚úÖ Solo asignados | ‚úÖ Todos | ‚úÖ Todos |
| **REQUEST (propia)** | ‚úÖ Ver/Comentar | ‚ùå | ‚úÖ Ver/Comentar | ‚úÖ Ver/Comentar |
| **REQUEST (ajena)** | ‚ùå | ‚ùå | ‚úÖ Todas | ‚úÖ Todas |
| **DELIVERABLE** | ‚úÖ Solo sus proyectos | ‚úÖ Solo sus tareas | ‚úÖ Todos | ‚úÖ Todos |

### **Validaci√≥n de permisos**:
```sql
-- Funci√≥n para verificar si usuario puede comentar en una entidad
CREATE OR REPLACE FUNCTION can_user_comment(
    p_user_id UUID,
    p_commentable_type VARCHAR,
    p_commentable_id UUID
) RETURNS BOOLEAN AS $$
BEGIN
    -- L√≥gica de validaci√≥n seg√∫n tipo de entidad y usuario
    -- Implementar reglas espec√≠ficas por cada caso
END;
$$ LANGUAGE plpgsql;
```